<html>
<head>
<title>mdx9_fase04-4</title>
<head>
<style type="text/css">

span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}


.sc1 {
	color: darkgreen;
	font-weight: bold;
}

.sntx {
	color: darkgreen;
	}


.sc2 {
	color: #008000;
}
.sc4 {
	color: #ff8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #FF0000;
}
.sc9 {
	color: #804000;
	font-weight: bold;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #400080;
}

.prg {
	color: #0000FF;
}

.prg-saida {

	margin-left:0px;
	width:500pt;
	background-color:lightblue;
	
}

.prg-code {
	margin-left:0px;
	width:515pt;
	background-color:lightyellow;
	padding:10px;
	font-weight:bold;
}


.niceview {
	margin-left:0px;
	width:500pt;
	background-color:white;
	border-color:lightgray;
	border-width:1px;
	border-style:solid;
	padding:10px;
}

td
{
padding:3px;
}

table.dados
{

margin-left:0px;
width:53.5em;
border-collapse:collapse;
border:1px solid red;
text-align:center;


}

th
{
background-color:darkgreen;
color:yellow;
font-weight:bold;
text-transform:uppercase;
}

.pagebody
{
padding:10px;
margin-left:50px;
border-width:1px;
border-style:solid;
border-color:white;
background-color:white;
width:90%;
}
.mybody
{
margin-top:20pt;
margin-bottom:20pt;
margin-left:20pt;
margin-right:20pt;
border-color:lightgray;
background-image:url('background.png');
}
</style>
<body class=mybody><font color="black">
<div class=pagebody>
<hr>
<center><b style="font-size:1.5em;" >Curso completo de DirectX Gerenciado</b><br>
Gameprog - Escola de programação de jogos digitais<br>
Contato: gameprog.br@gmail.com<br>
<b>Fase 04-4</b></center>
<hr>
<table align="left" border="0" cellspacing="0" cellpadding="0" width="20%">
<tr><td><a href="mdx9.html#start" style="color:blue"> index </a></td>
<td><a href="track04-3.html" style="color:blue">&lt;&lt;</a></td>
<td><a href="track04-5.html" style="color:blue">&gt;&gt;</a></td></tr></table><br><pre>

<hr><a name="track01"></a>
<h3 style="background-color:#80ff80">04.4 Carregando um modelo 3d</h3><pre>

<b><u>1.1 Visão geral</b></u>
<div class=prg-code>
<img src=images\prj_Modelo3d.png>
</div>
A classe <b class=prg>Mesh</b> tem uma função que carrega um modelo 3d  codificado  no
formato nativo do DirectX ( Ex.: modelo.x).  Depois que esse modelo é
carregado é necessário separar em variáveis arrays  suas  texturas  e
materiais. 

Depois para renderizar o objeto, a função que desenha o objeto deve
ter acesso ao objeto bem como seus dados de textura e materiais. 

<b><u>1.2 Estrutura da aplicação</b></u>


<b><u>2.1 Variáveis da classe</b></u>
<div class=niceview><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">partial</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">Tela</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Form</span>
<span class="sc10">{</span>
<span class="sc2">// Para criação do dispositivo gráfico </span>
<span class="sc5">private</span><span class="sc0"> </span><span class="sc11">Device</span><span class="sc0"> </span><span class="sc11">device</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span>

<span class="sc2">// Essa variável atualizada a cada ciclo ocasionará 
// a animação do objeto </span>
<span class="sc5">private</span><span class="sc0"> </span><span class="sc16">float</span><span class="sc0"> </span><span class="sc11">angulo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">;</span>
<b>
<span class="sc2">// Variável para guardar uma malha 3d  </span>
<span class="sc5">private Mesh</span><span class="sc0"> </span><span class="sc11">objeto3D</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span>

<span class="sc2">// Recipiente de materiais do mesh  </span>
<span class="sc5">private Material</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">g_meshMtl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span>

<span class="sc2">// Recipiente de texturas do mesh  </span>
<span class="sc5">private Texture</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">g_meshTex</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span>

<span class="sc2">// Pasta de localização do arquivo mesg e sua textura  </span>
<span class="sc5">private string</span><span class="sc0"> </span><span class="sc11">diretorioBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span>
</b>
<span class="sc2">// Vetores para a posição e rotação do objeto 3d  </span>
<span class="sc5">Vector3</span><span class="sc0"> </span><span class="sc11">posicao</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rotacao</span><span class="sc10">;</span>

<span class="sc2">// Variável global para propriedade dos objetos  </span>
<span class="sc5">Propriedades3D</span><span class="sc0"> </span><span class="sc11">g_props</span><span class="sc10">;</span>
</span></div>
<span class=prg>
private <b>Mesh</b> objeto3D = null; </span>
Esta variável vai receber o mesh carregado pela função <b>CarregarModelo()</b>
e vai ser utilizada na função <b>DesenharObjeto()</b> para renderizar o objeto
ao qual ela dá acesso.

<span class=prg>private <b>Material[]</b> g_meshMtl = null; </span>
Esta variável vai receber uma coleção de materiais presentes no arquivo
do modelo 3d carregado.

<span class=prg>private <b>Texture[]</b> g_meshTex = null; </span>
Esta variável vai receber uma coleção de texturas presentes no arquivo
do modelo 3d carregado.

Estas três variáveis são globais dentro da classe porque precisam ser
alimentadas   na  função  <b>CarregarModelo()</b>  e serem utilizadas para o
estabelecimento  do  material  e  da  textura  no  dispositivo para o
processo de renderização do mesh na função <b>DesenharObjeto().</b>

<span class=prg>private string <b>diretorioBase</b> = null; </span>
Esta string é  para  auxiliar o carregamento do  modelo  e  da  textura
sendo que ambos estarão no mesmo diretório. Ela participa da composição
do  nome  de  arquivo  completo  do modelo e de suas possíveis texturas 
contidas em arquivos separados. Porém é muito mais frequente  o arquivo
.x vier acompanhado de apenas um arquivo de textura  com várias imagens
em seu interior.

<b><u>2.3 Carregando o modelo 3d</b></u>
<div class=niceview><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CarregarModelo</span><span class="sc10">(</span><span class="sc5">string</span><span class="sc0"> </span><span class="sc11">diretorioBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">string</span><span class="sc0"> </span><span class="sc11">arquivo</span><span class="sc10">)</span>
<span class="sc10">{</span>
<span class="sc2">// Composição do nome final do arquivo </span>
<span class="sc5">string</span><span class="sc0"> </span><span class="sc11">caminhoFinal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">diretorioBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">arquivo</span><span class="sc10">;</span>

<span class="sc2">// Recebe nome do arquivo de textura sendo carregado </span>
<span class="sc5">string</span><span class="sc0"> </span><span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span>

<span class="sc2">// Quantidade de materiais\texturas encontrados no modelo3d </span>
<span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nTam</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span>

<span class="sc2">// Pacote de materiais e texturas do modelo 3d </span>
<span class="sc5">ExtendedMaterial</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">xMtl</span><span class="sc10">;</span>

<span class="sc2">// Carrega modelo 3d com suas texturas e materiais </span>
<span class="sc11">objeto3D</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">Mesh.FromFile</span><span class="sc10">(</span><span class="sc11">caminhoFinal</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MeshFlags</span><span class="sc10">.</span><span class="sc11">Managed</span><span class="sc10">,</span>
<span class="sc11">device</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">out</span><span class="sc0"> </span><span class="sc11">xMtl</span><span class="sc10">);</span>

<span class="sc2">// Verifica quantidade de texturas\materiais do modelo </span>
<span class="sc11">nTam</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">xMtl.Length</span><span class="sc10">;</span>

 <span class="sc2">// Carrega as texturas caso nTam &gt; 0 </span>
 <span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xMtl</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nTam</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span>
 <span class="sc10">{</span>

 <span class="sc2">// Inicializa as variáveis arrays de materiais e texturas </span>
 <span class="sc11">g_meshMtl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new Material</span><span class="sc10">[</span><span class="sc11">nTam</span><span class="sc10">];</span>
 <span class="sc11">g_meshTex</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new Texture</span><span class="sc10">[</span><span class="sc11">nTam</span><span class="sc10">];</span>

  <span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nTam</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc10">++)</span>
  <span class="sc10">{</span>
  <span class="sc2">// Carrega materiais </span>
  <span class="sc11">g_meshMtl</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">xMtl[ncx].Material3D</span><span class="sc10">;</span>

  <span class="sc2">// Carrega texturas </span>
  <span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">xMtl[ncx].TextureFilename</span><span class="sc10">;</span>
      <span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">String.Empty</span><span class="sc10">)</span>
      <span class="sc10">{</span>
	  <span class="sc11">g_meshTex</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">TextureLoader.FromFile</span><span class="sc10">(</span><span class="sc11">device</span><span class="sc10">,</span>
	  <span class="sc11">diretorioBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">arquivo_textura</span><span class="sc10">);</span><span class="sc0">
      <span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endif (texturas) </span>
   <span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endfor (materiais\texturas) </span>
  <span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endif (verificação de texturas\materiais presentes) </span>
<span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// CarregarModelo().fim </span>
</span></div>

<span class=prg><b>ExtendedMaterial[]</b> xMtl; </span>
Essa estrutura empacota uma coleção de materiais e uma coleção de nomes
de  arquivos  de  texturas. Cada elemento dessa array vai ter acesso à
propriedade  <b class=prg>.Material3D</b>  que  retorna  a  configuração de material do
subset  e a propriedade <b class=prg>.TextureFileName</b> retorna uma string com o nome
do arquivo de textura. Lembramos que o subset é cada  pequeno  membro
ou  peça 3d  tal como braços e pernas que entra na composição do mesh
final.Essa variável, <b>xMtl</b>, é provida como referência <b class=prg>out</b> na função do
DirectX que efetivamente carrega o mesh.
<span class=prg>
objeto3D = 
<b>Mesh.FromFile</b>( caminhoFinal,  MeshFlags.Managed,  device,  out xMtl); </span>
Essa função carrega efetivamente o objeto 3d para dentro da aplicação,
realizando o trabalho de preencher o buffer de vértices e o buffer de
índices  e  habilitar o acesso a materiais e texturas do mesh que foi
carregado. O flag expressado por  <b class=prg>MeshFlags.Managed</b>  indica que tanto
o  indexbuffer  como  o  vertexbuffer  ficarão  na  area  de  memória 
gerenciada  que  tem mecanismos de manipulação que restauram o objeto
quando o dispositivo é perdido ou resetado.

<span class=prg>nTam = <b>xMtl.Length;</b></span>
Essa variável vai ditar a quantidade de texturas e materiais presentes
no mesh.  Na sequência ela é necessária para alocar espaço nas arrays
globais de texturas e materiais:
<span class=prg>
g_meshMtl = new Material[nTam];
g_meshTex = new Texture[nTam]; </span>
Logicamente, você vai fazer isso apenas quando  <b>nTam</b>  for  maior  que 
zero(0). E vai utilizar um bloco for para alimentar  estas  variáveis
com conteúdo correto.

<span class=prg>g_meshMtl[ncx] = <b>xMtl[ncx].Material3D;</b> </span>
Aqui de fato os materiais são carregados para a variável array global
de materiais. Posteriormente em <b>DesenharObjeto()</b> o material  vai  ser
configurado dessa forma no dispositivo em um bloco for:
<span class=prg>device.Material = g_meshMtl[ncx]; </span>

<span class=prg>arquivo_textura = <b>xMtl[ncx].TextureFilename;</b></span>
Aqui é acessado o nome do arquivo da textura  que é carregado de fato
com esta linha: <span class=prg>
g_meshTex[ncx] = 
	<b>TextureLoader.FromFile</b>(device, diretorioBase + arquivo_textura); </span>
É importante tomar os cuidados para  evitar uma  string  inválida  ou
carregar um arquivo inexistente.

<b><u>2.4 Renderizando o modelo 3d</b></u>
<div class=niceview><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">desenharObjeto</span><span class="sc10">(</span><span class="sc11">Mesh</span><span class="sc0"> </span><span class="sc11">obj</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Propriedades3D</span><span class="sc0"> </span><span class="sc11">props</span><span class="sc10">)</span><span class="sc0">
<span class="sc10">{</span>

<span class="sc2">// Ajusta rotação do objeto 3d </span>
<span class="sc11">Matrix</span><span class="sc0"> </span><span class="sc11">obj_rot</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">RotationX</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">rotation</span><span class="sc10">.</span><span class="sc11">X</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">angulo</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span>
<span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">RotationY</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">rotation</span><span class="sc10">.</span><span class="sc11">Y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">
<span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">RotationZ</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">rotation</span><span class="sc10">.</span><span class="sc11">Z</span><span class="sc10">);</span><span class="sc0">

<span class="sc2">// Ajusta posição do objeto 3d </span>
<span class="sc11">Matrix</span><span class="sc0"> </span><span class="sc11">obj_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">Translation</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">position</span><span class="sc10">);</span><span class="sc0">

<span class="sc2">// Tranfere posição e rotação para o mundo </span>
<span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Transform</span><span class="sc10">.</span><span class="sc11">World</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">obj_rot</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">obj_pos</span><span class="sc10">;</span><span class="sc0">

<span class="sc2">// Prepara e aplica uma material\textura no objeto </span>
<span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc5">g_meshMtl.Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc10">++)</span><span class="sc0">
 <span class="sc10">{</span><span class="sc0">
 <span class="sc2">// Informa ao dispositivo o material a ser utilizado
 // na renderização </span>
 <span class="sc5">device.Material</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">g_meshMtl</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">];</span><span class="sc0">
 <span class="sc5">device.SetTexture</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">g_meshTex</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">]);</span><span class="sc0">
 <span class="sc2">// Renderiza o mesh </span>
 <span class="sc5">obj.DrawSubset</span><span class="sc10">(</span>ncx<span class="sc10">);</span><span class="sc0">
 <span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endfor </span>
<span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// desenharObjeto() </span>
</span></div>

É importante destacar que cada subset ou pedaço do objeto 3d recebe o
material, é texturizado e desenhado individualmente, passo a passo. O
modelo 3d tiny.x tem apenas um material, uma textura e uma só peça 3d,
porém a função <b>DesenharObjeto()</b> e <b>CarregarModelo()</b> já estão preparadas
para  lidar  com  objetos  complexos com muitas texturas, materiais e
várias subpartes. A quantidade  de  subpartes  vai corresponder com a
quantidade de materiais presentes no objeto.

<b><u>2.5 Configuração de câmera</b></u>
<div class=niceview><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">AtualizarCamera</span><span class="sc10">()</span>
<span class="sc10">{</span><span class="sc0">
<span class="sc2">// Dados para a configuração da matriz de projeção </span>
<span class="sc16">int</span><span class="sc0"> </span><span class="sc11">largura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">Width</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// largura da janela </span>
<span class="sc16">int</span><span class="sc0"> </span><span class="sc11">altura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">Height</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// altura da janela </span>
<span class="sc16">float</span><span class="sc0"> </span><span class="sc11">aspecto</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">largura</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">altura</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// aspecto dos gráficos </span>
<span class="sc16">float</span><span class="sc0"> </span><span class="sc11">campo_visao</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">float</span><span class="sc10">)</span><span class="sc11">Math</span><span class="sc10">.</span><span class="sc11">PI</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Campo de visão </span>
<span class="sc16">float</span><span class="sc0"> </span><span class="sc11">corte_perto</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1.0f</span><span class="sc10">;</span><span class="sc0">

<span class="sc2">// Essa variável foi modificar para acomodar o tamanho
// do modelo </span>
<span class="sc16">float</span><span class="sc0"> </span><span class="sc11">corte_longe</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1000.0f</span><span class="sc10">;</span>

<span class="sc2">// Atualiza angulo para dar movimento </span>
<span class="sc11">angulo</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0.01f</span><span class="sc10">;</span>

<span class="sc2">// Mostra a parte interna do polígono </span>
// Experimente desativar essa linha com a instrução de comentário </span>
<span class="sc11">device</span><span class="sc10">.</span><span class="sc11">RenderState</span><span class="sc10">.</span><span class="sc11">CullMode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Cull</span><span class="sc10">.</span><span class="sc11">None</span><span class="sc10">;</span>

<span class="sc2">// Configura a matriz de projeção </span>
<span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Transform</span><span class="sc10">.</span><span class="sc11">Projection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">PerspectiveFovLH</span><span class="sc10">(</span><span class="sc11">campo_visao</span><span class="sc10">,</span>
<span class="sc11">aspecto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">corte_perto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">corte_longe</span><span class="sc10">);</span><span class="sc0">

<span class="sc2">// Dados para a configuração da matriz de visualização
// O eixo z foi modificar para comportar o tamanho do modelo </span>
<span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">cam_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">600.0f</span><span class="sc10">);</span>

<span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">cam_alvo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">);</span>
<span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">cam_orientacao</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span>

<span class="sc2">// Configura a matriz de visualização </span>
<span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Transform</span><span class="sc10">.</span><span class="sc11">View</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">LookAtLH</span><span class="sc10">(</span><span class="sc11">cam_pos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cam_alvo</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cam_orientacao</span><span class="sc10">);</span>
<span class="sc10">}</span><span class="sc0">  </span><span class="sc2">// AtualizarCamera()
</span></div>

<b><u>Ajuste para a correta visualização do objeto</u></b>
Com muita frequência  vai  ser  necessário  fazer  ajuste  de  alguma
configuração  de  câmera  ou  de  escala  do  objeto para sua correta  
visualização na cena.

<span class=prg>float corte_longe = 1000.0f; </span>
Alteramos a configuração de <b>corte_longe</b> para alterar o frustum ou
região de alcance da câmera.  É normal essa configuração aparecer
com o valor 10000.0f em outras aplicações.

<span class=prg>Vector3 cam_pos = new Vector3(0, 0, <b>600.0f</b>); </span>
Aumentamos a distância entre o objeto e câmera.

<u>Ajuste de escala do objeto</u>
Para ajuste de escala você deve  utilizar  <b>Matrix.Scaling()</b>  de forma 
semelhante ao exemplo abaixo: <span class=prg>
device.Transform.World = 
		obj_rot * obj_pos * <b>Matrix.Scaling (150,150,150);</b></span>

<b><u>3. Código fonte do projeto de exemplo: prj_Modelo3d</b></u>
<div class=prg-code>
<img src=images\prj_Modelo3d.png>

<span class="sc2">// prj_Modelo3d - Arquivo: Tela.cs
// Esse projeto mostra como renderizar um modelo 3D
// Produzido por www.gameprog.com.br
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Drawing</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">ComponentModel</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Windows</span><span class="sc10">.</span><span class="sc11">Forms</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">Microsoft</span><span class="sc10">.</span><span class="sc11">DirectX</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">Microsoft</span><span class="sc10">.</span><span class="sc11">DirectX</span><span class="sc10">.</span><span class="sc11">Direct3D</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">namespace</span><span class="sc0"> </span><span class="sc11">prj_Modelo3d</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

  </span><span class="sc2">// Estrutura para propriedades 3d do objeto
</span><span class="sc0">  </span><span class="sc2">// posição, rotação e cor
</span><span class="sc0">  </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">Propriedades3D</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">position</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">rotation</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Color</span><span class="sc0"> </span><span class="sc11">color</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Propriedades3D</span><span class="sc10">(</span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">rot</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">position</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">rotation</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rot</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">color</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Color</span><span class="sc10">.</span><span class="sc11">White</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">};</span><span class="sc0">


  </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">partial</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">Tela</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Form</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Para criação do dispositivo gráfico
</span><span class="sc0">    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc11">Device</span><span class="sc0"> </span><span class="sc11">device</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Essa variável atualizada a cada ciclo ocasionará 
</span><span class="sc0">    </span><span class="sc2">// a animação do objeto
</span><span class="sc0">    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">float</span><span class="sc0"> </span><span class="sc11">angulo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Variável para guardar uma malha 3d
</span><span class="sc0">    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc11">Mesh</span><span class="sc0"> </span><span class="sc11">objeto3D</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Recipiente de materiais do mesh
</span><span class="sc0">    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc11">Material</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">g_meshMtl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Recipiente de texturas do mesh
</span><span class="sc0">    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc11">Texture</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">g_meshTex</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Pasta de localização do arquivo mesg e sua textura
</span><span class="sc0">    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">diretorioBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Vetores para a posição e rotação do objeto 3d
</span><span class="sc0">    </span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">posicao</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rotacao</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Variável global para propriedade dos objetos
</span><span class="sc0">    </span><span class="sc11">Propriedades3D</span><span class="sc0"> </span><span class="sc11">g_props</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Tela</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

      </span><span class="sc2">// Inicialização dos componentes.
</span><span class="sc0">      </span><span class="sc11">InitializeComponent</span><span class="sc10">();</span><span class="sc0">

      </span><span class="sc2">// Toda renderização deverá ocorrer dentro do evento onPaint()
</span><span class="sc0">      </span><span class="sc2">// Isso evita interferência estrangeira de processamento default
</span><span class="sc0">      </span><span class="sc2">// do sistema Windows
</span><span class="sc0">      </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">SetStyle</span><span class="sc10">(</span><span class="sc11">ControlStyles</span><span class="sc10">.</span><span class="sc11">AllPaintingInWmPaint</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">ControlStyles</span><span class="sc10">.</span><span class="sc11">Opaque</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// construtor
</span><span class="sc0">
    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">initGfx</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

      </span><span class="sc2">// Configuração dos parâmetros de apresentação
</span><span class="sc0">      </span><span class="sc11">PresentParameters</span><span class="sc0"> </span><span class="sc11">pps</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">PresentParameters</span><span class="sc10">();</span><span class="sc0">
      </span><span class="sc11">pps</span><span class="sc10">.</span><span class="sc11">Windowed</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">pps</span><span class="sc10">.</span><span class="sc11">SwapEffect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SwapEffect</span><span class="sc10">.</span><span class="sc11">Discard</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Ativando o buffer de profundidade
</span><span class="sc0">      </span><span class="sc11">pps</span><span class="sc10">.</span><span class="sc11">EnableAutoDepthStencil</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">pps</span><span class="sc10">.</span><span class="sc11">AutoDepthStencilFormat</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">DepthFormat</span><span class="sc10">.</span><span class="sc11">D16</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Adaptador default, processamento no hardware, processamento de vértice 
</span><span class="sc0">      </span><span class="sc2">// no software, janela (this), parâmetros de apresentação (pps)
</span><span class="sc0">      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">adaptador</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Device</span><span class="sc10">(</span><span class="sc11">adaptador</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DeviceType</span><span class="sc10">.</span><span class="sc11">Hardware</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">this</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">CreateFlags</span><span class="sc10">.</span><span class="sc11">SoftwareVertexProcessing</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pps</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc11">diretorioBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc13">@"c:\Gameprog\Gdkmedia\Modelos\Tiny\"</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">CarregarModelo</span><span class="sc10">(</span><span class="sc11">diretorioBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"tiny.x"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// initGfx()
</span><span class="sc0">
    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">AtualizarCamera</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc2">// Dados para a configuração da matriz de projeção
</span><span class="sc0">      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">largura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">Width</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// largura da janela
</span><span class="sc0">      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">altura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">Height</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// altura da janela      
</span><span class="sc0">      </span><span class="sc16">float</span><span class="sc0"> </span><span class="sc11">aspecto</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">largura</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">altura</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// aspecto dos gráficos      
</span><span class="sc0">      </span><span class="sc16">float</span><span class="sc0"> </span><span class="sc11">campo_visao</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">float</span><span class="sc10">)</span><span class="sc11">Math</span><span class="sc10">.</span><span class="sc11">PI</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Campo de visão
</span><span class="sc0">      </span><span class="sc16">float</span><span class="sc0"> </span><span class="sc11">corte_perto</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1.0f</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Essa variável foi modificar para acomodar o tamanho
</span><span class="sc0">      </span><span class="sc2">// do modelo
</span><span class="sc0">      </span><span class="sc16">float</span><span class="sc0"> </span><span class="sc11">corte_longe</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1000.0f</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Atualiza angulo para dar movimento
</span><span class="sc0">      </span><span class="sc11">angulo</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0.01f</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Mostra a parte interna do polígono
</span><span class="sc0">      </span><span class="sc2">// Experimente desativar essa linha com a instrução de comentário      
</span><span class="sc0">      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">RenderState</span><span class="sc10">.</span><span class="sc11">CullMode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Cull</span><span class="sc10">.</span><span class="sc11">None</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Configura a matriz de projeção
</span><span class="sc0">      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Transform</span><span class="sc10">.</span><span class="sc11">Projection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">PerspectiveFovLH</span><span class="sc10">(</span><span class="sc11">campo_visao</span><span class="sc10">,</span><span class="sc0">
          </span><span class="sc11">aspecto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">corte_perto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">corte_longe</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc2">// Dados para a configuração da matriz de visualização
</span><span class="sc0">      </span><span class="sc2">// O eixo z foi modificar para comportar o tamanho do modelo
</span><span class="sc0">      </span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">cam_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">600.0f</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">cam_alvo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">Vector3</span><span class="sc0"> </span><span class="sc11">cam_orientacao</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc2">// Configura a matriz de visualização
</span><span class="sc0">      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Transform</span><span class="sc10">.</span><span class="sc11">View</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">LookAtLH</span><span class="sc10">(</span><span class="sc11">cam_pos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cam_alvo</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cam_orientacao</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">  </span><span class="sc2">// AtualizarCamera()
</span><span class="sc0">
    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Renderizar</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

      </span><span class="sc2">// Limpa os dispositivos e os buffers de apoio
</span><span class="sc0">      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Clear</span><span class="sc10">(</span><span class="sc11">ClearFlags</span><span class="sc10">.</span><span class="sc11">Target</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">ClearFlags</span><span class="sc10">.</span><span class="sc11">ZBuffer</span><span class="sc10">,</span><span class="sc0"> 
        </span><span class="sc11">Color</span><span class="sc10">.</span><span class="sc11">White</span><span class="sc10">.</span><span class="sc11">ToArgb</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc4">1.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">BeginScene</span><span class="sc10">();</span><span class="sc0">
      </span><span class="sc2">// (...) Todo o código de desenhar vai aqui   
</span><span class="sc0">
      </span><span class="sc2">// Atualiza a câmera
</span><span class="sc0">      </span><span class="sc11">AtualizarCamera</span><span class="sc10">();</span><span class="sc0">
      </span><span class="sc11">AtualizarLuz</span><span class="sc10">();</span><span class="sc0">

      </span><span class="sc11">posicao</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0.0f</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">rotacao</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">g_props</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Propriedades3D</span><span class="sc10">(</span><span class="sc11">posicao</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rotacao</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">desenharObjeto</span><span class="sc10">(</span><span class="sc11">objeto3D</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">g_props</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">EndScene</span><span class="sc10">();</span><span class="sc0">

      </span><span class="sc2">// Apresenta a cena renderizada na tela
</span><span class="sc0">      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Present</span><span class="sc10">();</span><span class="sc0">

      </span><span class="sc2">// Libera a janela para processar outros eventos
</span><span class="sc0">      </span><span class="sc11">Application</span><span class="sc10">.</span><span class="sc11">DoEvents</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// Renderizar()
</span><span class="sc0">
    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">desenharObjeto</span><span class="sc10">(</span><span class="sc11">Mesh</span><span class="sc0"> </span><span class="sc11">obj</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Propriedades3D</span><span class="sc0"> </span><span class="sc11">props</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

      </span><span class="sc2">// Ajusta rotação do objeto 3d
</span><span class="sc0">      </span><span class="sc11">Matrix</span><span class="sc0"> </span><span class="sc11">obj_rot</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">RotationX</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">rotation</span><span class="sc10">.</span><span class="sc11">X</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">angulo</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">
        </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">RotationY</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">rotation</span><span class="sc10">.</span><span class="sc11">Y</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">
        </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">RotationZ</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">rotation</span><span class="sc10">.</span><span class="sc11">Z</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc2">// Ajusta posição do objeto 3d
</span><span class="sc0">      </span><span class="sc11">Matrix</span><span class="sc0"> </span><span class="sc11">obj_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Matrix</span><span class="sc10">.</span><span class="sc11">Translation</span><span class="sc10">(</span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">position</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc2">// Tranfere posição e rotação para o mundo
</span><span class="sc0">      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Transform</span><span class="sc10">.</span><span class="sc11">World</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">obj_rot</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">obj_pos</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Prepara e aplica uma material\textura no objeto
</span><span class="sc0">      </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">g_meshMtl</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc10">++)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// Informa ao dispositivo o material a ser utilizado
</span><span class="sc0">        </span><span class="sc2">// na renderização
</span><span class="sc0">        </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Material</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">g_meshMtl</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">SetTexture</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">g_meshTex</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc2">// Renderiza o mesh
</span><span class="sc0">        </span><span class="sc11">obj</span><span class="sc10">.</span><span class="sc11">DrawSubset</span><span class="sc11">(ncx);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endfor
</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// desenharObjeto()
</span><span class="sc0">

    </span><span class="sc2">// Configuração de luz
</span><span class="sc0">    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">AtualizarLuz</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">RenderState</span><span class="sc10">.</span><span class="sc11">Ambient</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Color</span><span class="sc10">.</span><span class="sc11">DarkGray</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">RenderState</span><span class="sc10">.</span><span class="sc11">Lighting</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Lights</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">LightType</span><span class="sc10">.</span><span class="sc11">Directional</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Lights</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">Diffuse</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Color</span><span class="sc10">.</span><span class="sc11">Yellow</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Lights</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">Direction</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Vector3</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Lights</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">Commit</span><span class="sc10">();</span><span class="sc0">
      </span><span class="sc11">device</span><span class="sc10">.</span><span class="sc11">Lights</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">Enabled</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// AtualizarLuz().fim
</span><span class="sc0">
    </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc5">override</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">OnPaint</span><span class="sc10">(</span><span class="sc11">PaintEventArgs</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc2">// Trate outros processos padrões
</span><span class="sc0">      </span><span class="sc5">base</span><span class="sc10">.</span><span class="sc11">OnPaint</span><span class="sc10">(</span><span class="sc11">e</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc2">// Renderize a cena
</span><span class="sc0">      </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">Renderizar</span><span class="sc10">();</span><span class="sc0">

      </span><span class="sc2">// Invalide para chamar novamente onPaint()
</span><span class="sc0">      </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">Invalidate</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// onPaint().fim 
</span><span class="sc0">
    </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CarregarModelo</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">diretorioBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">arquivo</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc2">// Composição do nome final do arquivo
</span><span class="sc0">      </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">caminhoFinal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">diretorioBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">arquivo</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Recebe nome do arquivo de textura sendo carregado
</span><span class="sc0">      </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Quantidade de materiais\texturas encontrados no modelo3d
</span><span class="sc0">      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nTam</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Pacote de materiais e texturas do modelo 3d
</span><span class="sc0">      </span><span class="sc11">ExtendedMaterial</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">xMtl</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Carrega modelo 3d com suas texturas e materiais
</span><span class="sc0">      </span><span class="sc11">objeto3D</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Mesh</span><span class="sc10">.</span><span class="sc11">FromFile</span><span class="sc10">(</span><span class="sc11">caminhoFinal</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MeshFlags</span><span class="sc10">.</span><span class="sc11">Managed</span><span class="sc10">,</span><span class="sc0"> 
        </span><span class="sc11">device</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">out</span><span class="sc0"> </span><span class="sc11">xMtl</span><span class="sc10">);</span><span class="sc0">

      </span><span class="sc2">// Verifica quantidade de texturas\materiais do modelo
</span><span class="sc0">      </span><span class="sc11">nTam</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xMtl</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc2">// Carrega as texturas caso nTam &gt; 0
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xMtl</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nTam</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc2">// Inicializa as variáveis arrays de materiais e texturas
</span><span class="sc0">        </span><span class="sc11">g_meshMtl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Material</span><span class="sc10">[</span><span class="sc11">nTam</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc11">g_meshTex</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Texture</span><span class="sc10">[</span><span class="sc11">nTam</span><span class="sc10">];</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nTam</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ncx</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc2">// Carrega materiais
</span><span class="sc0">          </span><span class="sc11">g_meshMtl</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xMtl</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">].</span><span class="sc11">Material3D</span><span class="sc10">;</span><span class="sc0">

          </span><span class="sc2">// Carrega texturas
</span><span class="sc0">          </span><span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xMtl</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">].</span><span class="sc11">TextureFilename</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">arquivo_textura</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">String</span><span class="sc10">.</span><span class="sc11">Empty</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">g_meshTex</span><span class="sc10">[</span><span class="sc11">ncx</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TextureLoader</span><span class="sc10">.</span><span class="sc11">FromFile</span><span class="sc10">(</span><span class="sc11">device</span><span class="sc10">,</span><span class="sc0"> 
              </span><span class="sc11">diretorioBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">arquivo_textura</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endif (texturas)
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endfor (materiais\texturas)
</span><span class="sc0">      </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// endif (verificação de texturas\materiais presentes)
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// CarregarModelo().fim
</span><span class="sc0">

  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// fim da classe
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// fim do namespace
</span></div></body>
<hr>
<table align="bottom" border="0" cellspacing="0" cellpadding="0" width="20%">
<tr><td><a href="mdx9.html#start" style="color:blue"> index </a></td>
<td><a href="track04-3.html" style="color:blue">&lt;&lt;</a></td>
<td><a href="track04-5.html" style="color:blue">&gt;&gt;</a></td></tr></table><pre>
<hr><div style="background-color:lightyellow;color:blue">
<center>Produzido por Gameprog: Jair Pereira - Março/2014 ©
gameprog.br@gmail.com
http://www.gameprog.com.br</center><hr></div></div></body></html>