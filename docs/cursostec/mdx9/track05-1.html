<html>
<head>
<title>mdx9_fase05-1</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}


.sc1 {
	color: darkgreen;
	font-weight: bold;
}

.sntx {
	color: darkgreen;
	}


.sc2 {
	color: #008000;
}
.sc4 {
	color: #ff8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #FF0000;
}
.sc9 {
	color: #804000;
	font-weight: bold;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #400080;
}

.prg {
	color: #0000FF;
}

.prg-saida {

	margin-left:0px;
	width:500pt;
	background-color:lightblue;	
}

.prg-code {
	margin-left:0px;
	width:515pt;
	background-color:lightyellow;
	padding:10px;
	font-weight:bold;
}


.niceview {
	margin-left:0px;
	width:500pt;
	background-color:white;
	border-color:lightgray;
	border-width:1px;
	border-style:solid;
	padding:10px;
}

td
{
padding:3px;
}

table.dados
{
margin-left:0px;
width:53.5em;
border-collapse:collapse;
border:1px solid red;
text-align:center;
}

th
{
background-color:darkgreen;
color:yellow;
font-weight:bold;
text-transform:uppercase;
}

.pagebody
{
padding:10px;
margin-left:50px;
border-width:1px;
border-style:solid;
border-color:white;
background-color:white;
width:90%;
}
.mybody
{
margin-top:20pt;
margin-bottom:20pt;
margin-left:20pt;
margin-right:20pt;
border-color:lightgray;
background-image:url('background.png');
}
</style>
</head>
<body class=mybody><font color='black'>
<div class=pagebody>
<hr>
<center><b style='font-size:1.5em;' >Curso completo de DirectX Gerenciado</b><br>
Gameprog - Escola de programação de jogos digitais<br>
Contato: gameprog.br@gmail.com<br>
<b>Fase 05-1</b></center>
<hr>
<table align='left' border='0' cellspacing='0' cellpadding='0' width='20%'>
<tr><td><a href='mdx9.html#start' style='color:blue'> index </a></td>
<td><a href='track04-6.html' style='color:blue'>&lt;&lt;</a></td>
<td><a href='track05-2.html' style='color:blue'>&gt;&gt;</a></td></tr></table><br><pre>
<hr><a name='topo'></a>
<h3 style='background-color:#80ff80'>05.1 Teclado 1/2: teclas pressionadas</h3><pre>
<b><u>1. Visão geral</b></u>
<div class=prg-code><img src=images\prj_Teclado01.png></div>
O acesso aos dispositivos de entrada compreendendo o teclado, mouse e
joysticks é  viabilizado pela  biblioteca DirectInput  acessada  pelo
namespace  <b class=prg>Microsoft.DirectX.DirectInput</b>  cuja  referência  deve  ser
adicionada ao projeto. 

A criação do objeto gerenciador do dispositivo  de  entrada  é  feita
pela classe <b class=prg>Device</b> desse namespace. Visto que ocorre  um  conflito de
nomes  com a classe <span class=prg>Device</span> também presente em outros namespaces vamos
utilizar o apelido <b>DirectInput</b> para qualificar todas as entidades que
vamos utilizar do namespace <span class=prg>Microsoft.DirectX.DirectInput.</span>

<b><u>1.2 Estrutura da aplicação</b></u>
<div class=prg-code>
<img src=images\esquema_prj_Teclado01.png></div>
A aplicação de exemplo vai permitir a movimentação de uma <span class=prg>string</span>, que
representa  o  'jogador',  utilizando as setas de direção do teclado.
Como  vamos  mostrar  uma string isso explica a presença de um objeto
<b class=prg>Direct3D.Font</b>  e  de  uma  função e variáveis auxiliares para mostrar
a <span class=prg>string</span> do jogador e sua posição na tela.

A inicialização do teclado é feito numa função separada para isso por
questões de melhor organização do código  em  <b>inicializarTeclado()</b>. A
função <b>verificarTeclado()</b> verifica o teclado e atualiza a  lógica  do
jogo  que  depois  ganha  uma  representação  visual dada pela função
<b>Renderizar()</b>.

A  tecla  <b>Escape</b> vai permitir finalizar a aplicação cuja execução vai
ser monitorada pela variável booleana <b>terminar</b>.

<b><u>2.1 Variáveis da classe</u></b>
<div class=niceview><span class=prg>public </span><span class=prg>partial </span><span class=prg>class </span>Tela : <span class=sc5>Form</span>
<span class=sc16>{</span>

<b><span class=sc2>// Variável para criação do dispositivo de gerenciamento teclado</span>
<span class=prg>private </span><span class=prg>DirectInput.Device </span>teclado = <span class=prg>null;</span></b>

<span class=sc2>// Para criação do dispositivo gráfico</span>
<span class=prg>private </span><span class=sc5>Device </span>device = <span class=prg>null;</span>

<span class=sc2>// A tecla Escape terminará a aplicação</span>
<span class=prg>private </span><span class=prg>bool </span>terminar = <span class=prg>false;</span>

<span class=sc2>// Dados para o 'jogador'</span>
<span class=prg>private </span><span class=prg>int </span>xcol; 
<span class=prg>private </span><span class=prg>int </span>ylin; 
<span class=prg>string </span>jogador = <span class=prg>null;</span>

<span class=sc2>// Fontes para mostrar o 'jogador' na tela</span>
<span class=sc2>// Objeto Font do DirectX para mostrar texto (titulos)</span>
<span class=prg>private </span><span class=prg>Direct3D.Font </span>dxfTitulo = <span class=prg>null;</span>
<span class=sc2>// Objeto Font tradicional do namespace System.Drawing</span>
<span class=prg>private </span><span class=prg>System.Drawing.Font </span>g_font = <span class=prg>null;</span>

<span class=sc2>// (...)</span>

} <span class=sc2>// fim da classe</span></div>

<b><span class=prg>private </span><span class=prg>DirectInput.Device </span>teclado = <span class=prg>null;</span></b>
Esta  variável  vai ser utilizada para a criação  do  dispositivo  de
entrada, o teclado.

<span class=prg>private </span><span class=prg>bool </span>terminar = <span class=prg>false;</span>
Esta variável quando for configurada como <span class=prg>true</span> com o  pressionamento
da tecla ESC terminará a aplicação.

<span class=sc2>// Dados para o 'jogador'</span>
<span class=prg>private </span><span class=prg>int </span>xcol; 
<span class=prg>private </span><span class=prg>int </span>ylin; 
<span class=prg>string </span>jogador = <span class=prg>null;</span>
Estas variáveis vão permitir a movimentação da <span class=prg>string</span> que  representa
o jogador; <b>xcol</b> controla o movimentação horizontal e <b>ylin</b> controla  a
movimentação vertical.

<span class=sc2>// Fontes para mostrar o 'jogador' na tela</span>
<span class=sc2>// Objeto Font do DirectX para mostrar texto (titulos)</span>
<span class=prg>private </span><span class=prg>Direct3D.Font </span>dxfTitulo = <span class=prg>null;</span>
<span class=sc2>// Objeto Font tradicional do namespace System.Drawing</span>
<span class=prg>private </span><span class=prg>System.Drawing.Font </span>g_font = <span class=prg>null;</span>
Estas variáveis vão permitir a impressão de  texto  na  tela  que vão
mostrar o jogador e seu posicionamento.

<b><u>2.2 Inicializando teclado</u></b>
<div class=niceview><span class=prg>public </span><span class=prg>void </span>initGfx() 
<span class=sc16>{</span>

 <span class=sc2>// Configuração dos parâmetros de apresentação</span>
 <span class=sc5>PresentParameters </span>pps = <span class=prg>new </span><span class=sc5>PresentParameters</span>();  
 <span class=prg>pps.Windowed </span>= <span class=prg>true;</span>
 <span class=prg>pps.SwapEffect </span>= <span class=prg>SwapEffect.Discard;</span>

 <span class=sc2>// Adaptador default, processamento no hardware, processamento de vértice</span>
 <span class=sc2>// no software, janela (this), parâmetros de apresentação (pps)</span>
 <span class=prg>int </span>adaptador = 0; 
 device = <span class=prg>new </span><span class=sc5>Device</span>(adaptador, <span class=prg>DeviceType.Hardware</span>, <span class=prg>this</span>, 
 <span class=prg>CreateFlags.SoftwareVertexProcessing</span>, pps);  

 <span class=sc2>// Configuração das fontes para mostrar títulos</span>
 g_font = <span class=prg>new </span><span class=prg>System.Drawing.Font</span>(<span class=sc6>"Arial"</span>, <span class=sc4>36.0f</span>, <span class=prg>FontStyle.Bold</span>);  
 dxfTitulo = <span class=prg>new </span><span class=prg>Direct3D.Font</span>(device, g_font);  

 <span class=sc2>// Inicializa jogador</span>
 xcol = 320; 
 ylin = 240; 
 jogador = <span class=sc6>":-)&gt;";</span>

 <b>inicializarTeclado();</b>

<span class=sc16>} <span class=sc2>// initGfx().fim</span></span>
</div>
<span class=sc2>// Inicializa jogador</span>
xcol = 320; 
ylin = 240; 
jogador = <span class=sc6>":-)&gt;";</span>
Inicialização das variáveis de controle de movimentação da <span class=prg>string</span>
<b>jogador</b> na tela.

<b>inicializarTeclado();</b>
Essa função faz a inicialização do dispositivo de entrada:
<div class=niceview><span class=prg>private </span><span class=prg>void </span>inicializarTeclado() 
<span class=sc16>{</span>
 <span class=sc2>// Cria o dispositivo de gerenciamento do teclado</span>
 teclado = <span class=prg>new </span><span class=prg>DirectInput.Device</span>(<span class=prg>DirectInput.SystemGuid.Keyboard</span>);  

 <span class=sc2>// Configura nível de cooperação</span>
 <span class=prg>teclado.SetCooperativeLevel</span>(<span class=prg>this</span>, 
 <span class=prg>DirectInput.CooperativeLevelFlags.Background </span>| 
 <span class=prg>DirectInput.CooperativeLevelFlags.NonExclusive</span>);  

 <span class=sc2>// Adquire o teclado</span>
 <span class=prg>teclado.Acquire</span>();  

<span class=sc16>} <span class=sc2>// inicializarTeclado().fim</span></span>
</div>
<b>
<span class=sc2>// Cria o dispositivo de gerenciamento do teclado</span>
teclado = <span class=prg>new </span><span class=prg>DirectInput.Device</span>(<span class=prg>DirectInput.SystemGuid.Keyboard</span>); </b>
Esta  linha  cria o objeto <span class=prg>DirectInput.Device</span> que permite  acesso  ao
teclado. Os dispositivos de entrada são criados a partir de <b>GUID's</b> que
são  identificadores  globais  e únicos de dispositivos instalados em
um computador.


<b><span class=sc2>// Configura nível de cooperação</span>
<span class=prg>teclado.SetCooperativeLevel</span>(<span class=prg>this</span>,
 <span class=prg>DirectInput.CooperativeLevelFlags.Background </span>| 
   <span class=prg>DirectInput.CooperativeLevelFlags.NonExclusive</span>);  </b>
O método <span class=prg>SetCooperativeLevel()</span> estabelece o nível de cooperação entre
sua aplicação e as demais aplicações que estão rodando simultaneamente
na  mesma  sessão  do Windows e que utilizam os mesmos dispositivos de
entrada. Grande parte da complexidade do desenvolvimento de aplicações
para o sistema Windows decorre do fato de que o  sistema  roda  várias
aplicações  ao  mesmo  que  utilizam  de  forma  concorrente  recursos 
muitas  vezes  únicos  como  o teclado, mouse e o vídeo. Da forma como 
está  configurado  nesse  exemplo, esta função estabelece que o uso do
teclado  não  vai ser exclusivo de nossa aplicação e que o teclado vai
ser  lido  e  processado  mesmo quando a aplicação não estiver em foco.

O  modo <span class=prg>Background</span>  de  acesso ao teclado é mais simples de usar visto 
que no outro modo, o <span class=prg>Foreground</span>, a aplicação precisa gerenciar a perda
e  reaquisição do dispositivo quando a aplicação perde  e ganha o foco
dado pelo usuário. 

O modo <span class=prg>Background</span> produz um efeito  interessante  mas  que  pode  ser 
indesejável  na  maioria  das vezes, o processamento do teclado ou de
qualquer  outro  dispositivo  de  entrada assumido continua ocorrendo 
mesmo quando o usuário está usando  outra aplicação.   Porém  isso  é
facilmente  corrigido  aplicando um <b class=prg>return</b> na função de verificação e
tratamento do dispositivo de  entrada  envolvido  na  questão  quando
nossa aplicação não estiver ativa.

<b><span class=sc2>// Adquire o teclado</span>
<span class=prg>teclado.Acquire</span>();</b>
Todo dispositivo para ser usado  deve  ser  adquirido  com  o  método
<span class=prg>Acquire().</span>

<b><u>2.3 A função Renderizar()</u></b>
<div class=niceview><span class=prg>public </span><span class=prg>void </span>Renderizar() 
<span class=sc16>{</span>

 <b>verificarTeclado();  
 <span class=sc9>if </span>(terminar == <span class=prg>true</span>)  return;</b>

 <span class=sc2>// Limpa os dispositivos e os buffers de apoio</span>
 <span class=prg>device.Clear</span>(<span class=prg>ClearFlags.Target</span>, <span class=prg>Color.White</span>, <span class=sc4>1.0f</span>, <span class=sc4>0</span>);  

 <span class=prg>device.BeginScene</span>();  
 <span class=sc2>// (...) Todo o código de desenhar vai aqui</span>

 <b><span class=sc2>// Mostra 'jogador' e sua posição na tela</span>
 <span class=sc5>String </span>info = <span class=prg>String.Format</span>(<span class=sc6>"</span>({0},{1})<span class=sc6>"</span>, xcol, ylin);  
 MostrarTitulo(10, 10, info, <span class=prg>Color.Black</span>);  
 MostrarTitulo(xcol, ylin, jogador, <span class=prg>Color.Red</span>);</b>

 <span class=prg>device.EndScene</span>();  

 <span class=sc2>// Apresenta a cena renderizada na tela</span>
 <span class=prg>device.Present</span>();  

 <span class=sc2>// Libera a janela para processar outros eventos</span>
 <span class=prg>Application.DoEvents</span>();  
<span class=sc16>} <span class=sc2>// Renderizar()</span></span>
</div>

<b>verificarTeclado();  </b>
Essa função permite  ao usuário  modificar com as setas do teclado as
coordenadas <b>(xcol, ylin)</b> que posiciona a string na tela.

<b><span class=sc9>if </span>(terminar == <span class=prg>true</span>)  return;</b>
Esta linha é muito necessária  para evitar que a função  <b>Renderizar()</b>
tente rodar código com o dispositivo gráfico  eliminado  no  decorrer
do processo de fechamento da aplicação pelo bloco de código  acionado
pela tecla ESC.

<b><span class=sc2>// Mostra 'jogador' e sua posição na tela</span>
<span class=sc5>String </span>info = <span class=prg>String.Format</span>(<span class=sc6>"</span>({0},{1})<span class=sc6>"</span>, xcol, ylin);  
MostrarTitulo(10, 10, info, <span class=prg>Color.Black</span>);  
MostrarTitulo(xcol, ylin, jogador, <span class=prg>Color.Red</span>);</b>
Aqui mostramos a string <b>jogador</b> na coordenada <b>(xcol, ylin)</b>  e  também
sua posição na tela.

<b><u>2.4 Verificando o teclado</u></b>
<div class=niceview><span class=prg>void </span>verificarTeclado() 
<span class=sc16>{</span>

 <span class=prg>string </span>sInfo = <span class=sc6>"prj_Teclado01 - Teclas pressionadas: ";</span>

 <span class=sc2>// Variáveis para guardar o estado das teclas</span>
 <span class=prg>int </span>seta_esquerda = 0; 
 <span class=prg>int </span>seta_direita = 0; 
 <span class=prg>int </span>seta_cima = 0; 
 <span class=prg>int </span>seta_abaixo = 0; 
<b>
 <span class=prg>DirectInput.Key</span>[] teclasPressionadas = <span class=prg>teclado.GetPressedKeys</span>();  

 <span class=sc2>// Verifica teclado e atualiza teclas de estado</span>
  <span class=prg>foreach </span>(<span class=prg>DirectInput.Key </span>tecla <span class=prg>in </span>teclasPressionadas ) 
  <span class=sc16>{</span>
   sInfo += <span class=prg>tecla.ToString</span>() + <span class=sc6>" ";</span>

   <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.DownArrow </span>)  seta_abaixo = 1; 
   <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.UpArrow   </span>)  seta_cima = 1; 
   <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.LeftArrow </span>)  seta_esquerda = 1; 
   <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightArrow</span>)  seta_direita = 1; 
   <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightShift</span>)  xcol = 320; 
   <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightShift</span>)  ylin = 240; 
   <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.Escape    </span>)  terminar = <span class=prg>true;</span>
   <span class=sc16>} <span class=sc2>// endfor each</span></span></b>

  <span class=sc2>// Atualiza posicionamento do 'jogador'</span>
  <span class=sc9>if </span>(seta_abaixo ==   <span class=sc4>1</span>)  ylin += 5; 
  <span class=sc9>if </span>(seta_cima ==     <span class=sc4>1</span>)  ylin -= 5; 
  <span class=sc9>if </span>(seta_esquerda == <span class=sc4>1</span>)  xcol -= 5; 
  <span class=sc9>if </span>(seta_direita ==  <span class=sc4>1</span>)  xcol += 5; 

  <span class=sc2>// Muda 'jogador' conforme seta pressionada</span>
  <span class=sc9>if </span>(seta_esquerda == <span class=sc4>1</span>)  jogador = <span class=sc6>"&lt;</span>(<span class=sc6>-:";</span>
  <span class=sc9>if </span>(seta_direita ==  <span class=sc4>1</span>)  jogador = <span class=sc6>":-</span>)<span class=sc6>&gt;";</span>

  <span class=prg>this.Text </span>= sInfo; 

  <span class=sc2>// Processa a tecla Escape</span>
  <span class=sc9>if </span>(terminar) 
  <span class=sc16>{</span>
   <span class=prg>device.Dispose</span>();  
   <span class=prg>teclado.Dispose</span>();  
   <span class=prg>this.Close</span>();  
   <span class=prg>Application.Exit</span>();  
  <span class=sc16>} <span class=sc2>// endif</span></span>
<span class=sc16>} <span class=sc2>// AtualizarTeclado()</span></span>
</div>
<b>
<span class=sc2>// Variáveis para guardar o estado das teclas</span>
<span class=prg>int </span>seta_esquerda = 0; 
<span class=prg>int </span>seta_direita  = 0; 
<span class=prg>int </span>seta_cima     = 0; 
<span class=prg>int </span>seta_abaixo   = 0; </b>
Estas variáveis de estado são 'ligadas' conforme a tecla  pressionada
e acionam a movimentação do 'jogador' na tela.

<b><span class=prg>DirectInput.Key</span>[] teclasPressionadas = <span class=prg>teclado.GetPressedKeys</span>();</b>
O  método  teclado<span class=prg>.GetPressedKeys()</span>  retorna  uma  array  de  teclas
pressionadas.

<b><span class=sc2>// Verifica teclado e atualiza teclas de estado</span>
<span class=prg>foreach </span>(<span class=prg>DirectInput.Key </span>tecla <span class=prg>in </span>teclasPressionadas ) 
<span class=sc16>{</span>
 sInfo += <span class=prg>tecla.ToString</span>() + <span class=sc6>" ";</span>
 <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.DownArrow </span>)  seta_abaixo = 1; 
 <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.UpArrow   </span>)  seta_cima = 1; 
 <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.LeftArrow </span>)  seta_esquerda = 1; 
 <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightArrow</span>)  seta_direita = 1; 
 <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightShift</span>)  xcol = 320; 
 <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightShift</span>)  ylin = 240; 
 <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.Escape    </span>)  terminar = <span class=prg>true;</span>
<span class=sc16>} <span class=sc2>// endfor each</span></span></b>
Aqui todas as teclas pressionadas  são  verificadas  neste  bloco  de
código  do  <span class=prg>foreach</span>  modificando o valor das respectivas variáveis de
estado.
<b>
<span class=sc2>// Atualiza posicionamento do 'jogador'</span>
<span class=sc9>if </span>(seta_abaixo == <span class=sc4>1  </span>)  ylin += 5; 
<span class=sc9>if </span>(seta_cima == <span class=sc4>1    </span>)  ylin -= 5; 
<span class=sc9>if </span>(seta_esquerda == <span class=sc4>1</span>)  xcol -= 5; 
<span class=sc9>if </span>(seta_direita == <span class=sc4>1 </span>)  xcol += 5; </b>
Na sequência a avaliação das variáveis de estado vão ocasionar a
modificação nas coordenadas (xcol, ylin).
<b>
<span class=sc2>// Muda 'jogador' conforme seta pressionada</span>
<span class=sc9>if </span>(seta_esquerda == <span class=sc4>1</span>)  jogador = <span class=sc6>"&lt;</span>(<span class=sc6>-:";</span>
<span class=sc9>if </span>(seta_direita ==  <span class=sc4>1</span>)  jogador = <span class=sc6>":-</span>)<span class=sc6>&gt;";</span></b>
Aqui  é  um  pequeno  ajuste  da imagem do jogador na tela conforme a
direção  pressionada  pelo usuário. Não é muito comum chamar um texto 
na tela de 'imagem' mas é a pura verdade, o texto é desenhado na tela
visto que o Sistema Windows é um ambiente puramente gráfico.

<b><span class=sc2>// Processa a tecla Escape</span>
<span class=sc9>if </span>(terminar) 
 <span class=sc16>{</span>
  <span class=prg>device.Dispose</span>();  
  <span class=prg>teclado.Dispose</span>();  
  <span class=prg>this.Close</span>();  
  <span class=prg>Application.Exit</span>();  
<span class=sc16>} <span class=sc2>// endif</span></span></b>
Aqui é feito uma finalização responsável da aplicação com a  dispensa
dos  dispositivos  usados  através do método <span class=prg>.Dispose()</span> que libera os
recursos utilizados.  Depois  desse  código é importante garantir que
a  função  <b>Renderizar()</b> que pode ser acionada por uma  outra linha de
execução  retorne  de  imediado ao perceber que o dispositivo gráfico
está nulo ou  perceber que a variável <b>terminar</b> está setada como <b class=prg>true</b>.

<b><u>3. Código fonte do projeto de exemplo:prj_Teclado01</u></b>

<div class=prg-code>
<img src=images\prj_Teclado01.png>

<span class=sc2>// prj_Teclado01 - Arquivo: Tela.cs</span>
<span class=sc2>// Esse projeto mostra como usar o teclado via DirectInput</span>
<span class=sc2>// Exemplo 01 - Produzido por www.gameprog.com.br</span>
<span class=sc16>using </span><span class=sc16>System;</span>
<span class=sc16>using </span><span class=prg>System.Drawing;</span>
<span class=sc16>using </span><span class=prg>System.ComponentModel;</span>
<span class=sc16>using </span><span class=prg>System.Windows.Forms;</span>
<span class=sc16>using </span><span class=prg>Microsoft.DirectX;</span>
<span class=sc16>using </span><span class=prg>Microsoft.DirectX.Direct3D;</span>
<span class=sc16>using </span>Direct3D = <span class=prg>Microsoft.DirectX.Direct3D;</span>
<span class=sc16>using </span>DirectInput = <span class=prg>Microsoft.DirectX.DirectInput;</span>

<span class=sc16>namespace </span>prj_Teclado01 
<span class=sc16>{</span>


  <span class=prg>public </span><span class=prg>partial </span><span class=prg>class </span>Tela : <span class=sc5>Form</span>
  <span class=sc16>{</span>


    <span class=sc2>// Variável para criação do dispositivo de gerenciamento teclado</span>
    <span class=prg>private </span><span class=prg>DirectInput.Device </span>teclado = <span class=prg>null;</span>


    <span class=sc2>// Para criação do dispositivo gráfico</span>
    <span class=prg>private </span><span class=sc5>Device </span>device = <span class=prg>null;</span>

    <span class=sc2>// A tecla Escape terminará a aplicação</span>
    <span class=prg>private </span><span class=prg>bool </span>terminar = <span class=prg>false;</span>

    <span class=sc2>// Dados para o 'jogador'</span>
    <span class=prg>private </span><span class=prg>int </span>xcol; 
    <span class=prg>private </span><span class=prg>int </span>ylin; 
    <span class=prg>string </span>jogador = <span class=prg>null;</span>

    <span class=sc2>// Fontes para mostrar o 'jogador' na tela</span>
    <span class=sc2>// Objeto Font do DirectX para mostrar texto (titulos)</span>
    <span class=prg>private </span><span class=prg>Direct3D.Font </span>dxfTitulo = <span class=prg>null;</span>
    <span class=sc2>// Objeto Font tradicional do namespace System.Drawing</span>
    <span class=prg>private </span><span class=prg>System.Drawing.Font </span>g_font = <span class=prg>null;</span>

    <span class=sc2>// (...)</span>

    <span class=prg>public </span>Tela() 
    <span class=sc16>{</span>

      <span class=sc2>// Inicialização dos componentes.</span>
      InitializeComponent();  
      <span class=prg>this.Size </span>= <span class=prg>new </span>Size(640, 480);  

      <span class=sc2>// Toda renderização deverá ocorrer dentro do evento onPaint()</span>
      <span class=sc2>// Isso evita interferência estrangeira de processamento default</span>
      <span class=sc2>// do sistema Windows</span>
      <span class=prg>this.SetStyle</span>(<span class=prg>ControlStyles.AllPaintingInWmPaint </span>| <span class=prg>ControlStyles.Opaque</span>, <span class=prg>true</span>);  

    <span class=sc16>} <span class=sc2>// construtor</span></span>


    <span class=prg>public </span><span class=prg>void </span>initGfx() 
    <span class=sc16>{</span>

      <span class=sc2>// Configuração dos parâmetros de apresentação</span>
      <span class=sc5>PresentParameters </span>pps = <span class=prg>new </span><span class=sc5>PresentParameters</span>();  
      <span class=prg>pps.Windowed </span>= <span class=prg>true;</span>
      <span class=prg>pps.SwapEffect </span>= <span class=prg>SwapEffect.Discard;</span>

      <span class=sc2>// Adaptador default, processamento no hardware, processamento de vértice</span>
      <span class=sc2>// no software, janela (this), parâmetros de apresentação (pps)</span>
      <span class=prg>int </span>adaptador = 0; 
      device = <span class=prg>new </span><span class=sc5>Device</span>(adaptador, <span class=prg>DeviceType.Hardware</span>, <span class=prg>this</span>, 
        <span class=prg>CreateFlags.SoftwareVertexProcessing</span>, pps);  

      <span class=sc2>// Configuração das fontes para mostrar títulos</span>
      g_font = <span class=prg>new </span><span class=prg>System.Drawing.Font</span>(<span class=sc6>"Arial"</span>, <span class=sc4>36.0f</span>, <span class=prg>FontStyle.Bold</span>);  
      dxfTitulo = <span class=prg>new </span><span class=prg>Direct3D.Font</span>(device, g_font);  

      <span class=sc2>// Inicializa jogador</span>
      xcol = 320; 
      ylin = 240; 
      jogador = <span class=sc6>":-</span>)<span class=sc6>&gt;";</span>

      inicializarTeclado();  


    <span class=sc16>} <span class=sc2>// initGfx()</span></span>


    <span class=prg>public </span><span class=prg>void </span>Renderizar() 
    <span class=sc16>{</span>


      verificarTeclado();  
      <span class=sc9>if </span>(terminar == <span class=prg>true</span>)  return; 


      <span class=sc2>// Limpa os dispositivos e os buffers de apoio</span>
      <span class=prg>device.Clear</span>(<span class=prg>ClearFlags.Target</span>, <span class=prg>Color.White</span>, <span class=sc4>1.0f</span>, <span class=sc4>0</span>);  

      <span class=prg>device.BeginScene</span>();  
      <span class=sc2>// (...) Todo o código de desenhar vai aqui</span>

      <span class=sc2>// Mostra 'jogador' e sua posição na tela</span>
      <span class=sc5>String </span>info = <span class=prg>String.Format</span>(<span class=sc6>"</span>({0},{1})<span class=sc6>"</span>, xcol, ylin);  
      MostrarTitulo(10, 10, info, <span class=prg>Color.Black</span>);  
      MostrarTitulo(xcol, ylin, jogador, <span class=prg>Color.Red</span>); 

      <span class=prg>device.EndScene</span>();  

      <span class=sc2>// Apresenta a cena renderizada na tela</span>
      <span class=prg>device.Present</span>();  

      <span class=sc2>// Libera a janela para processar outros eventos</span>
      <span class=prg>Application.DoEvents</span>();  
    <span class=sc16>} <span class=sc2>// Renderizar()</span></span>

    <span class=prg>protected </span><span class=prg>override </span><span class=prg>void </span>OnPaint(<span class=sc5>PaintEventArgs </span>e) 
    <span class=sc16>{</span>
      <span class=sc2>// Trate outros processos padrões</span>
      <span class=prg>base.OnPaint</span>(e);  

      <span class=sc2>// Renderize a cena</span>
      Renderizar();  

      <span class=sc2>// Invalide para chamar novamente onPaint()</span>
      <span class=prg>this.Invalidate</span>();  
    <span class=sc16>} <span class=sc2>// onPaint().fim</span></span>

    <span class=prg>private </span><span class=prg>void </span>inicializarTeclado() 
    <span class=sc16>{</span>
      <span class=sc2>// Cria o dispositivo de gerenciamento do teclado</span>
      teclado = <span class=prg>new </span><span class=prg>DirectInput.Device</span>(<span class=prg>DirectInput.SystemGuid.Keyboard</span>);  

      <span class=sc2>// Configura nível de cooperação</span>
      <span class=prg>teclado.SetCooperativeLevel</span>(<span class=prg>this</span>, 
        <span class=prg>DirectInput.CooperativeLevelFlags.Background </span>| 
           <span class=prg>DirectInput.CooperativeLevelFlags.NonExclusive</span>);  

      <span class=sc2>// Adquire o teclado</span>
      <span class=prg>teclado.Acquire</span>();  

    <span class=sc16>} <span class=sc2>// inicializarTeclado().fim</span></span>

    <span class=prg>void </span>verificarTeclado() 
    <span class=sc16>{</span>

      <span class=prg>string </span>sInfo = <span class=sc6>"prj_Teclado01 - Teclas pressionadas: ";</span>

      <span class=sc2>// Variáveis para guardar o estado das teclas</span>
      <span class=prg>int </span>seta_esquerda = 0; 
      <span class=prg>int </span>seta_direita = 0; 
      <span class=prg>int </span>seta_cima = 0; 
      <span class=prg>int </span>seta_abaixo = 0; 


      <span class=prg>DirectInput.Key</span>[] teclasPressionadas = <span class=prg>teclado.GetPressedKeys</span>();  

      <span class=sc2>// Verifica teclado e atualiza teclas de estado</span>
      <span class=prg>foreach </span>(<span class=prg>DirectInput.Key </span>tecla <span class=prg>in </span>teclasPressionadas ) 
      <span class=sc16>{</span>
        sInfo += <span class=prg>tecla.ToString</span>() + <span class=sc6>" ";</span>

        <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.DownArrow</span>)  seta_abaixo = 1; 
        <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.UpArrow</span>)  seta_cima = 1; 
        <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.LeftArrow</span>)  seta_esquerda = 1; 
        <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightArrow</span>)  seta_direita = 1; 
        <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightShift</span>)  xcol = 320; 
        <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.RightShift</span>)  ylin = 240; 
        <span class=sc9>if </span>(tecla == <span class=prg>DirectInput.Key.Escape</span>)  terminar = <span class=prg>true;</span>
      <span class=sc16>} <span class=sc2>// endfor each</span></span>


      <span class=sc2>// Atualiza posicionamento do 'jogador'</span>
      <span class=sc9>if </span>(seta_abaixo == <span class=sc4>1</span>)  ylin += 5; 
      <span class=sc9>if </span>(seta_cima == <span class=sc4>1</span>)  ylin -= 5; 
      <span class=sc9>if </span>(seta_esquerda == <span class=sc4>1</span>)  xcol -= 5; 
      <span class=sc9>if </span>(seta_direita == <span class=sc4>1</span>)  xcol += 5; 

      <span class=sc2>// Muda 'jogador' conforme seta pressionada</span>
      <span class=sc9>if </span>(seta_esquerda == <span class=sc4>1</span>)  jogador = <span class=sc6>"&lt;</span>(<span class=sc6>-:";</span>
      <span class=sc9>if </span>(seta_direita == <span class=sc4>1</span>)  jogador = <span class=sc6>":-</span>) <span class=sc6>&gt;";</span>

      <span class=prg>this.Text </span>= sInfo; 

      <span class=sc2>// Processa a tecla Escape</span>
      <span class=sc9>if </span>(terminar) 
      <span class=sc16>{</span>
        <span class=prg>device.Dispose</span>();  
        <span class=prg>teclado.Dispose</span>();  
        <span class=prg>this.Close</span>();  
        <span class=prg>Application.Exit</span>();  
      <span class=sc16>} <span class=sc2>// endif</span></span>

    <span class=sc16>} <span class=sc2>// AtualizarTeclado()</span></span>



    <span class=sc2>// Mostra texto com tamanho de fonte grande para títulos</span>
    <span class=prg>private </span><span class=prg>void </span>MostrarTitulo(<span class=prg>int </span>xpos, <span class=prg>int </span>ylin, <span class=prg>string </span>txt, <span class=sc5>Color </span>font_cor) 
    <span class=sc16>{</span>
      <span class=sc2>// Configura posição</span>
      <span class=sc5>Rectangle </span>position = <span class=prg>new </span><span class=sc5>Rectangle</span>(xpos, ylin, <span class=sc4>0</span>, <span class=sc4>0</span>);  

      <span class=sc2>// Mostra texto</span>
      <span class=prg>dxfTitulo.DrawText</span>(<span class=prg>null</span>, txt, position, <span class=prg>DrawTextFormat.NoClip</span>, font_cor);  
    <span class=sc16>} <span class=sc2>// MostrarTitulo().fim</span></span>

  <span class=sc16>} <span class=sc2>// fim da classe</span></span>
<span class=sc16>} <span class=sc2>// fim do namespace</span></span>
</div>
<hr>
<table align='bottom' border='0' cellspacing='0' cellpadding='0' width='20%'>
<tr><td><a href='mdx9.html#start' style='color:blue'> index </a></td>
<td><a href='track04-6.html' style='color:blue'>&lt;&lt;</a></td>
<td><a href='track05-2.html' style='color:blue'>&gt;&gt;</a></td></tr></table><pre>
<hr><div style='background-color:lightyellow;color:blue'>
<center>Produzido por Gameprog: Jair Pereira - Março/2014 ©
gameprog.br@gmail.com
<a href='http://www.gameprog.com.br'>http://www.gameprog.com.br</center><hr></div></div></body></html>

